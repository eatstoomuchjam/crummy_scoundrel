<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="/inc/jquery.terminal-0.4.11.min.js"></script>
<link href="/inc/jquery.terminal.css" rel="stylesheet"/>
<title>Miserable drunkard</title>
</head>
<body>
<div id="terminal"></div>
<script language="javascript">
  function getParameterByName(name) {
    var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
  }
  var nickName = getParameterByName('nickName');
  var serverName = getParameterByName('serverName');
  var channels = getParameterByName('channels');
  var hostName = window.location.hostname;
  var hostPort = window.location.port;

  var channelsTemp = channels.split(',');
  var useChannels = [];
  channelsTemp.forEach(function(channel) {
    useChannels.push('#' + channel);
  });

  var socket=io.connect('http://' + hostName + ':' + hostPort);
  var term = {};

  socket.on('connect', function() {
    socket.emit('login', { nickName: nickName, serverName: serverName, channels: useChannels });
    console.log('nickName: ' + nickName);
    console.log('serverName: ' + serverName);
    console.log('channels: ' + useChannels);
  });
  socket.on('message', function(data) {
    if(data.to && !data.to.match(/^#/)) {
      term.echo(data.from + '->' + data.to + ': ' + data.message);
    } else {
      term.echo(data.from + ': ' + data.message);
    }
  })
  socket.on('motd', function(data) {
    term.echo(data);
  });
  socket.on('join', function(data) {
    term.echo(data.nick + ' joined ' + data.channel);
  });
  socket.on('registered', function(data) {
    term.echo(data);
  });
  socket.on('error', function(data) {
    term.echo('error received');
    term.echo(data);
    console.log(data);
  });
  
  term=$('#terminal').terminal(function(command, terminal) {
    socket.emit('message', command);
  }, {
    width: 1024,
    height: 768,
    prompt: nickName + '>',
    greetings: null
  });
</script>
</body>
</html>
